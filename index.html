<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <link rel="icon" href="favicon2.png" type="image/png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª ××¢×§×‘ ××§×“××™ ××©×•×¤×¨×ª</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/lucide@0.395.0/dist/umd/lucide.min.js"></script>

    <style>
        body { font-family: 'Assistant', sans-serif; }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        .dark ::-webkit-scrollbar-track { background: #2d3748; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #555; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #444; }
        /* Style for sortable table headers */
        .sortable { cursor: pointer; user-select: none; }
        .sortable:hover { color: #3b82f6; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 transition-colors duration-300">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 dark:text-gray-200" id="header-title">×œ×•×— ×‘×§×¨×” ××§×“××™</h1>
                <p class="text-gray-500 dark:text-gray-400" id="header-subtitle">×‘×¨×•×š ×”×‘×!</p>
            </div>
            <div class="flex items-center space-x-2 rtl:space-x-reverse">
                <button id="settings-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300">
                    <i data-lucide="settings"></i>
                </button>
                <button id="info-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300">
                    <i data-lucide="info"></i>
                </button>
                <button id="dark-mode-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300">
                    <i data-lucide="moon" class="block dark:hidden"></i>
                    <i data-lucide="sun" class="hidden dark:block"></i>
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <div class="lg:col-span-2 flex flex-col gap-6">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm text-center">
                        <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400">×××•×¦×¢ ××©×•×§×œ×œ</h3>
                        <p id="avg-grade" class="text-3xl font-bold text-blue-600 dark:text-blue-400 mt-1">0.00</p>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm text-center">
                        <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400">×¡×”"×› × "×–</h3>
                        <p id="total-credits" class="text-3xl font-bold text-indigo-600 dark:text-indigo-400 mt-1">0</p>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm text-center">
                        <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400">×¦×™×•×Ÿ ×©×™×</h3>
                        <p id="highest-grade" class="text-lg font-bold text-green-600 dark:text-green-400 mt-1 truncate">-</p>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm text-center">
                        <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400">×¦×™×•×Ÿ × ××•×š</h3>
                        <p id="lowest-grade" class="text-lg font-bold text-red-600 dark:text-red-400 mt-1 truncate">-</p>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm">
                    <div class="flex justify-between items-center mb-1">
                        <h3 class="font-bold text-gray-700 dark:text-gray-300">×”×ª×§×“××•×ª ×‘×ª×•××¨</h3>
                        <span id="degree-progress-text" class="text-sm font-semibold text-blue-600 dark:text-blue-400">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                        <div id="degree-progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
                
                <div id="form-container" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm">
                    <h2 id="form-title" class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4">×”×•×¡×¤×ª ×§×•×¨×¡ ×—×“×©</h2>
                    <form id="course-form" class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                        <div class="md:col-span-2">
                            <label for="courseName" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">×©× ×”×§×•×¨×¡</label>
                            <input type="text" id="courseName" placeholder="×œ×“×•×’××”: ××‘×•× ×œ××“×¢×™ ×”××—×©×‘" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition dark:placeholder-gray-500">
                        </div>
                        <div>
                            <label for="credits" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">× "×–</label>
                            <input type="number" id="credits" step="0.5" min="0" placeholder="3.5" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition dark:placeholder-gray-500">
                        </div>
                        <div>
                            <label for="grade" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">×¦×™×•×Ÿ</label>
                            <input type="number" id="grade" min="0" max="100" placeholder="88" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition dark:placeholder-gray-500">
                        </div>
                        <div>
                            <label for="semester" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">×¡××¡×˜×¨</label>
                            <input type="number" id="semester" min="1" placeholder="1" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition dark:placeholder-gray-500">
                        </div>
                        <div>
                            <label for="courseCategory" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">×§×˜×’×•×¨×™×”</label>
                            <select id="courseCategory" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                                </select>
                        </div>
                        <div class="md:col-span-2 flex items-center gap-x-6 gap-y-2 flex-wrap">
                             <div class="flex items-center pt-2">
                                <input id="isMoedB" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <label for="isMoedB" class="mr-2 text-sm font-medium text-gray-900 dark:text-gray-300">××•×¢×“ ×‘'</label>
                            </div>
                            <div class="flex items-center pt-2">
                                <input id="isPassFail" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-green-600 focus:ring-green-500">
                                <label for="isPassFail" class="mr-2 text-sm font-medium text-gray-900 dark:text-gray-300">×¦×™×•×Ÿ ×‘×™× ××¨×™</label>
                            </div>
                        </div>
                        <div class="md:col-span-2 flex gap-4 mt-2">
                            <button type="submit" id="submit-btn" class="flex-grow bg-blue-600 text-white font-bold p-2.5 rounded-lg hover:bg-blue-700 transition-colors shadow">×”×•×¡×£ ×§×•×¨×¡</button>
                            <button type="button" id="cancel-edit-btn" class="hidden flex-grow bg-gray-500 text-white font-bold p-2.5 rounded-lg hover:bg-gray-600 transition-colors">×‘×˜×œ ×¢×¨×™×›×”</button>
                        </div>
                    </form>
                </div>

                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm">
                    <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                        <h2 class="text-xl font-bold text-gray-800 dark:text-gray-200">×¨×©×™××ª ×§×•×¨×¡×™×</h2>
                        <div class="flex gap-2">
                            <button id="what-if-btn" class="flex items-center gap-2 text-sm bg-purple-500 text-white font-semibold px-3 py-1.5 rounded-lg hover:bg-purple-600 transition">
                                <i data-lucide="calculator" class="w-4 h-4"></i>
                                ××—×©×‘×•×Ÿ "××” ××"
                            </button>
                             <button id="export-csv-btn" class="flex items-center gap-2 text-sm bg-green-500 text-white font-semibold px-3 py-1.5 rounded-lg hover:bg-green-600 transition">
                                <i data-lucide="download" class="w-4 h-4"></i>
                                ×™×™×¦×•× ×œ-CSV
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <input type="search" id="search-input" placeholder="×—×¤×© ×§×•×¨×¡..." class="md:col-span-2 w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-gray-200 focus:ring-2 focus:ring-blue-500 dark:placeholder-gray-500">
                        <select id="filter-semester" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-gray-200 focus:ring-2 focus:ring-blue-500">
                            <option value="all">×›×œ ×”×¡××¡×˜×¨×™×</option>
                        </select>
                         <select id="filter-category" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-gray-200 focus:ring-2 focus:ring-blue-500">
                            <option value="all">×›×œ ×”×§×˜×’×•×¨×™×•×ª</option>
                        </select>
                    </div>

                    <div class="overflow-x-auto max-h-96">
                        <table class="w-full text-sm text-gray-500 dark:text-gray-400">
                            <thead class="text-xs text-gray-700 dark:text-gray-300 uppercase bg-gray-100 dark:bg-gray-700 sticky top-0">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-right sortable" data-sort="name">×§×•×¨×¡ <i data-lucide="arrow-down-up" class="inline-block w-3 h-3"></i></th>
                                    <th scope="col" class="px-4 py-3 text-right sortable" data-sort="category">×§×˜×’×•×¨×™×” <i data-lucide="arrow-down-up" class="inline-block w-3 h-3"></i></th>
                                    <th scope="col" class="px-4 py-3 text-right sortable" data-sort="semester">×¡××¡×˜×¨ <i data-lucide="arrow-down-up" class="inline-block w-3 h-3"></i></th>
                                    <th scope="col" class="px-4 py-3 text-right sortable" data-sort="credits">× "×– <i data-lucide="arrow-down-up" class="inline-block w-3 h-3"></i></th>
                                    <th scope="col" class="px-4 py-3 text-right sortable" data-sort="grade">×¦×™×•×Ÿ <i data-lucide="arrow-down-up" class="inline-block w-3 h-3"></i></th>
                                    <th scope="col" class="px-4 py-3 text-right">××•×¢×“</th>
                                    <th scope="col" class="px-4 py-3 text-center">×¤×¢×•×œ×•×ª</th>
                                </tr>
                            </thead>
                            <tbody id="course-list" class="divide-y divide-gray-200 dark:divide-gray-700">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-1 flex flex-col gap-6">
                 <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm">
                    <h3 class="font-bold text-gray-700 dark:text-gray-300 mb-3">×××•×¦×¢×™× ×¡××¡×˜×¨×™××œ×™×™×</h3>
                    <div id="semester-averages" class="space-y-2 text-sm">
                        <p class="text-gray-400">××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”.</p>
                    </div>
                    <hr class="my-4 border-gray-200 dark:border-gray-600">
                    <h3 class="font-bold text-gray-700 dark:text-gray-300 mb-3">×××•×¦×¢×™× ×œ×¤×™ ×§×˜×’×•×¨×™×”</h3>
                    <div id="category-averages" class="space-y-2 text-sm">
                         <p class="text-gray-400">××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”.</p>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm">
                    <h3 class="font-bold text-gray-700 dark:text-gray-300 mb-2">××’××ª ×¦×™×•× ×™×</h3>
                    <div class="h-48"><canvas id="trend-chart"></canvas></div>
                </div>

                <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm">
                    <h3 class="font-bold text-gray-700 dark:text-gray-300 mb-2">×”×ª×¤×œ×’×•×ª ××•×¢×“×™×</h3>
                    <div class="h-48"><canvas id="moed-chart"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8 w-full max-w-md m-4 transform transition-all">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200">×”×’×“×¨×•×ª</h2>
                <button id="close-settings-btn" class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <form id="settings-form" class="space-y-4">
                <div>
                    <label for="userName" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">×©× ×”×¡×˜×•×“× ×˜</label>
                    <input type="text" id="userName" placeholder="×¡××•×¡×¨" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-gray-200 focus:ring-2 focus:ring-blue-500 dark:placeholder-gray-500">
                </div>
                <div>
                    <label for="institution" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">××•×¡×“ ×œ×™××•×“×™×</label>
                    <input type="text" id="institution" placeholder="×”××•× ×™×‘×¨×¡×™×˜×” ×”×¢×‘×¨×™×ª" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-gray-200 focus:ring-2 focus:ring-blue-500 dark:placeholder-gray-500">
                </div>
                <div>
                    <label for="major" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">×ª×—×•× ×œ×™××•×“</label>
                    <input type="text" id="major" placeholder="×”× ×“×¡×ª ××›×•× ×•×ª" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-gray-200 focus:ring-2 focus:ring-blue-500 dark:placeholder-gray-500">
                </div>
                 <div>
                    <label for="requiredCredits" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">×¡×”"×› × "×– ×œ×ª×•××¨</label>
                    <input type="number" id="requiredCredits" min="1" placeholder="160" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-gray-200 focus:ring-2 focus:ring-blue-500 dark:placeholder-gray-500">
                </div>
                <div>
                    <label for="userCategories" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">×§×˜×’×•×¨×™×•×ª ×§×•×¨×¡×™× (××•×¤×¨×“ ×‘×¤×¡×™×§)</label>
                    <input type="text" id="userCategories" placeholder="×—×•×‘×”, ×‘×—×™×¨×”, ×›×œ×œ×™, ×¡×¤×•×¨×˜, ×”×ª××—×•×ª" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-gray-200 focus:ring-2 focus:ring-blue-500 dark:placeholder-gray-500">
                </div>
                <div class="pt-4 flex justify-between items-center">
                    <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">×©××•×¨ ×©×™× ×•×™×™×</button>
                    <button type="button" id="clear-data-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">××—×§ ××ª ×›×œ ×”× ×ª×•× ×™×</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
            <i data-lucide="alert-triangle" class="mx-auto h-12 w-12 text-red-500"></i>
            <h3 class="text-lg font-medium text-gray-900 dark:text-gray-200 mt-2">××™×©×•×¨ ××—×™×§×”</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×›×œ ×”× ×ª×•× ×™×? ×¤×¢×•×œ×” ×–×• ××™× ×” ×”×¤×™×›×”.</p>
            <div class="mt-6 flex justify-center gap-4">
                <button id="confirm-delete-btn" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">×›×Ÿ, ××—×§ ×”×›×œ</button>
                <button id="cancel-delete-btn" class="bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-md hover:bg-gray-400 dark:hover:bg-gray-500">×‘×™×˜×•×œ</button>
            </div>
        </div>
    </div>

    <div id="what-if-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8 w-full max-w-md m-4 transform transition-all">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200">××—×©×‘×•×Ÿ ×××•×¦×¢ ×¢×ª×™×“×™</h2>
                <button id="close-what-if-btn" class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="space-y-4">
                <p class="text-gray-600 dark:text-gray-400 text-sm">×”×–×Ÿ ×¦×™×•× ×™× ×•× ×§×•×“×•×ª ×–×›×•×ª ×©×œ ×§×•×¨×¡×™× ×¢×ª×™×“×™×™× ×›×“×™ ×œ×¨××•×ª ××™×š ×”×××•×¦×¢ ×”××©×•×§×œ×œ ×©×œ×š ×™×•×©×¤×¢. ×”× ×ª×•× ×™× ×›××Ÿ ×œ× × ×©××¨×™×.</p>
                <div id="what-if-courses" class="space-y-2">
                    </div>
                <button id="add-what-if-course-btn" class="w-full text-sm bg-gray-200 dark:bg-gray-700 p-2 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition">×”×•×¡×£ ×§×•×¨×¡ × ×•×¡×£</button>
                <hr class="my-4 border-gray-200 dark:border-gray-600">
                <div class="text-center">
                    <h3 class="text-lg font-semibold text-gray-500 dark:text-gray-400">×”×××•×¦×¢ ×”×—×“×© ×©×œ×š ×™×”×™×”:</h3>
                    <p id="what-if-result" class="text-4xl font-bold text-purple-600 dark:text-purple-400 mt-2">0.00</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">××‘×•×¡×¡ ×¢×œ <span id="what-if-credits-info"></span></p>
                </div>
            </div>
        </div>
    </div>

    <div id="info-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8 w-full max-w-2xl m-4 transform transition-all max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200">××“×¨×™×š ×œ××©×ª××© - ××¢×¨×›×ª ××¢×§×‘ ××§×“××™ ğŸš€</h2>
                <button id="close-info-btn" class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="overflow-y-auto pr-4 -mr-4 text-gray-700 dark:text-gray-300 space-y-4">
                <p>×”×›×œ×™ ×”×–×” × ×‘× ×” ×›×“×™ ×œ×¢×–×•×¨ ×œ×›× ×œ×¢×§×•×‘ ×‘×§×œ×•×ª ××—×¨ ×”×¦×™×•× ×™×, ×œ×—×©×‘ ×××•×¦×¢×™× ×•×œ×”×‘×™×Ÿ ××ª ××¦×‘×›× ×”××§×“××™. ××˜×¨×ª×• ×”××¨×›×–×™×ª ×”×™× ×œ×ª×ª ×œ×›× <strong>×©×œ×™×˜×” ××œ××” ×¢×œ ×”× ×ª×•× ×™×</strong> ×•×œ××¤×©×¨ ×œ×›× ×œ×¨××•×ª ××™×š ×›×œ ×©×™× ×•×™ ×¦×™×•×Ÿ ××©×¤×™×¢ ××™×™×“×™×ª ×¢×œ ×”×××•×¦×¢.</p>
                
                <div>
                    <h3 class="font-bold text-lg mb-2 text-gray-800 dark:text-gray-200">×¤×¨×˜×™×•×ª ×•×©××™×¨×ª × ×ª×•× ×™× ğŸ”</h3>
                    <ul class="list-disc list-inside space-y-1">
                        <li><strong>××™×¤×” ×”× ×ª×•× ×™× × ×©××¨×™×?</strong> ×›×œ ×”××™×“×¢ × ×©××¨ ×‘××•×¤×Ÿ ××§×•××™ ×¢×œ ×”×“×¤×“×¤×Ÿ ×©×œ×›× ×‘×œ×‘×“.</li>
                        <li><strong>×”×¤×¨×˜×™×•×ª ×©×œ×›× ××•×‘×˜×—×ª:</strong> ××¤×ª×— ×”××ª×¨ ××™× ×• ×™×›×•×œ ×œ×¨××•×ª ××ª ×”× ×ª×•× ×™× ×©×œ×›×. ×”××™×“×¢ ×œ× × ×©×œ×— ×œ×©×•× ×©×¨×ª.</li>
                        <li><strong>×©×™××• ×œ×‘:</strong> ×× ×ª×‘×¦×¢×• <strong>"× ×™×§×•×™ × ×ª×•× ×™ ×’×œ×™×©×”"</strong> ×‘×“×¤×“×¤×Ÿ, ×›×œ ×”××™×“×¢ ×©×”×–× ×ª× ×™×™××—×§ ×œ×¦××™×ª×•×ª!</li>
                    </ul>
                </div>

                <div>
                    <h3 class="font-bold text-lg mb-2 text-gray-800 dark:text-gray-200">×ª×›×•× ×•×ª ××¨×›×–×™×•×ª âš™ï¸</h3>
                    <ul class="list-disc list-inside space-y-1">
                        <li><strong>×”×’×“×¨×•×ª:</strong> ×œ×—×¦×• ×¢×œ ×’×œ×’×œ ×”×©×™× ×™×™× ×›×“×™ ×œ×”×–×™×Ÿ ××ª ×¡×š ×”× "×– ×œ×ª×•××¨ (×‘×©×‘×™×œ ××“ ×”×”×ª×§×“××•×ª) ×•×œ×”×ª××™× ××™×©×™×ª ××ª ×§×˜×’×•×¨×™×•×ª ×”×§×•×¨×¡×™×.</li>
                        <li><strong>×¢×¨×™×›×ª ×§×•×¨×¡:</strong> ×›×“×™ ×œ×¢×¨×•×š ×§×•×¨×¡ ×§×™×™×, ×œ×—×¦×• ×¢×œ ××™×™×§×•×Ÿ ×”×¢×™×¤×¨×•×Ÿ (<i data-lucide="edit" class="inline-block w-4 h-4"></i>) ×‘×©×•×¨×ª ×”×§×•×¨×¡ ×”×¨×¦×•×™.</li>
                        <li><strong>×¦×™×•×Ÿ ×‘×™× ××¨×™ (×¢×•×‘×¨/× ×›×©×œ):</strong> ×¡×× ×• ××¤×©×¨×•×ª ×–×• ×œ×§×•×¨×¡×™× ×œ×œ× ×¦×™×•×Ÿ ××¡×¤×¨×™. ×§×•×¨×¡ ×›×–×” <strong>×›×Ÿ ×™×™×¡×¤×¨ ×‘× "×–</strong> ××š <strong>×œ× ×™×©×¤×™×¢ ×¢×œ ×”×××•×¦×¢</strong>.</li>
                        <li><strong>××—×©×‘×•×Ÿ "××” ××":</strong> ×”×›×œ×™ ×××¤×©×¨ ×œ×›× ×œ×”×–×™×Ÿ ×¦×™×•× ×™× ×¢×ª×™×“×™×™× ×•×œ×¨××•×ª ××™×š ×”× ×™×©×¤×™×¢×• ×¢×œ ×”×××•×¦×¢, ××‘×œ×™ ×œ×©××•×¨ ××•×ª×.</li>
                        <li><strong>××™×•×Ÿ ×•×¡×™× ×•×Ÿ:</strong> × ×™×ª×Ÿ ×œ×—×¤×© ×§×•×¨×¡, ×œ×¡× ×Ÿ ×œ×¤×™ ×¡××¡×˜×¨/×§×˜×’×•×¨×™×”, ×•×œ××™×™×Ÿ ××ª ×”×˜×‘×œ×” ×¢×œ ×™×“×™ ×œ×—×™×¦×” ×¢×œ ×”×›×•×ª×¨×•×ª.</li>
                    </ul>
                </div>

                 <div>
                    <h3 class="font-bold text-lg mb-2 text-gray-800 dark:text-gray-200">×”×‘× ×ª ×”×’×¨×¤×™× ğŸ“Š</h3>
                    <p>×”×’×¨×¤×™× ×‘×¦×“ × ×•×ª× ×™× ×œ×›× ×ª××•× ×” ×•×™×–×•××œ×™×ª: <strong>××’××ª ×”×¦×™×•× ×™×</strong> ××¨××” ××ª ×”×××•×¦×¢ ×‘×›×œ ×¡××¡×˜×¨ ×›×“×™ ×œ×¨××•×ª ×”×ª×§×“××•×ª, ×•<strong>×”×ª×¤×œ×’×•×ª ××•×¢×“×™×</strong> ××¨××” ×›××” ××‘×—× ×™× ×¢×‘×¨×ª× ×‘××•×¢×“ ×' ×œ×¢×•××ª ××•×¢×“ ×‘'.</p>
                </div>
                <div class="pt-4 text-xs text-center text-gray-400">
                    <p>×¤×•×ª×— ×‘××”×‘×” ×¢×œ ×™×“×š, ×”××¤×ª×— ğŸ‘¨â€ğŸ’»</p>
                </div>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- STATE MANAGEMENT ---
        let state = {
            courses: [],
            userInfo: {
                name: '',
                institution: '',
                major: '',
                requiredCredits: 120,
                categories: ['×—×•×‘×”', '×‘×—×™×¨×”', '×›×œ×œ×™', '×¡×¤×•×¨×˜']
            },
            editMode: { active: false, courseId: null },
            darkMode: false,
            viewState: {
                searchTerm: '',
                filterSemester: 'all',
                filterCategory: 'all',
                sortBy: 'semester',
                sortOrder: 'asc'
            }
        };

        // --- DOM ELEMENTS ---
        const courseForm = document.getElementById('course-form');
        const courseListEl = document.getElementById('course-list');
        const formTitle = document.getElementById('form-title');
        const submitBtn = document.getElementById('submit-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        // Inputs
        const courseNameInput = document.getElementById('courseName');
        const creditsInput = document.getElementById('credits');
        const gradeInput = document.getElementById('grade');
        const semesterInput = document.getElementById('semester');
        const isMoedBInput = document.getElementById('isMoedB');
        const isPassFailInput = document.getElementById('isPassFail');
        const courseCategoryInput = document.getElementById('courseCategory');
        // Summary Cards
        const avgGradeEl = document.getElementById('avg-grade');
        const totalCreditsEl = document.getElementById('total-credits');
        const highestGradeEl = document.getElementById('highest-grade');
        const lowestGradeEl = document.getElementById('lowest-grade');
        // Progress & Averages
        const degreeProgressText = document.getElementById('degree-progress-text');
        const degreeProgressBar = document.getElementById('degree-progress-bar');
        const semesterAveragesEl = document.getElementById('semester-averages');
        const categoryAveragesEl = document.getElementById('category-averages');
        // Settings Modal
        const settingsModal = document.getElementById('settings-modal');
        const settingsForm = document.getElementById('settings-form');
        const userNameInput = document.getElementById('userName');
        const institutionInput = document.getElementById('institution');
        const majorInput = document.getElementById('major');
        const requiredCreditsInput = document.getElementById('requiredCredits');
        const userCategoriesInput = document.getElementById('userCategories');
        // Header
        const headerTitle = document.getElementById('header-title');
        const headerSubtitle = document.getElementById('header-subtitle');
        // Confirm Modal
        const confirmModal = document.getElementById('confirm-modal');
        // What-If Modal
        const whatIfModal = document.getElementById('what-if-modal');
        const whatIfCoursesContainer = document.getElementById('what-if-courses');
        const whatIfResultEl = document.getElementById('what-if-result');
        const whatIfCreditsInfoEl = document.getElementById('what-if-credits-info');
        // Info Modal
        const infoModal = document.getElementById('info-modal');
        // Filtering and Sorting
        const searchInput = document.getElementById('search-input');
        const filterSemesterEl = document.getElementById('filter-semester');
        const filterCategoryEl = document.getElementById('filter-category');

        // --- CHARTS ---
        let moedChart, trendChart;
        const chartDefaultFont = { family: "'Assistant', sans-serif", size: 12 };
        
        // --- LOCAL STORAGE ---
        function saveState() {
            localStorage.setItem('academicTrackerState_v2', JSON.stringify(state));
        }

        function loadState() {
            const savedState = localStorage.getItem('academicTrackerState_v2');
            if (savedState) {
                state = { ...state, ...JSON.parse(savedState) };
                if (!state.viewState) {
                    state.viewState = { searchTerm: '', filterSemester: 'all', filterCategory: 'all', sortBy: 'semester', sortOrder: 'asc' };
                }
            }
        }

        // --- CORE LOGIC & RENDERING ---
        
        function updateDashboard() {
            renderTable();
            calculateAndRenderSummary();
            renderSemesterAverages();
            renderCategoryAverages();
            renderCharts();
            updateHeader();
            populateFilterOptions();
            saveState();
        }

        function renderTable() {
            courseListEl.innerHTML = '';
            
            const filteredAndSortedCourses = getFilteredAndSortedCourses();

            if (filteredAndSortedCourses.length === 0) {
                courseListEl.innerHTML = `<tr><td colspan="7" class="text-center p-8 text-gray-400">×œ× × ××¦××• ×§×•×¨×¡×™× ×”×ª×•×××™× ××ª ×”×—×™×¤×•×©.</td></tr>`;
                return;
            }
            
            filteredAndSortedCourses.forEach(course => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700';

                let gradeDisplay;
                if (course.isPassFail) {
                    gradeDisplay = `<span class="font-bold text-gray-500 dark:text-gray-400">×¢×‘×¨</span>`;
                } else {
                    const gradeColor = course.grade >= 85 ? 'text-green-500' : 'text-gray-700 dark:text-gray-300';
                    gradeDisplay = `<span class="font-bold ${gradeColor}">${course.grade}</span>`;
                }
                
                row.innerHTML = `
                    <td class="px-4 py-3 font-medium text-gray-900 dark:text-gray-200">${course.name}</td>
                    <td class="px-4 py-3"><span class="bg-gray-100 text-gray-800 text-xs font-medium px-2.5 py-0.5 rounded-full dark:bg-gray-700 dark:text-gray-300">${course.category}</span></td>
                    <td class="px-4 py-3">${course.semester}</td>
                    <td class="px-4 py-3">${course.credits}</td>
                    <td class="px-4 py-3">${gradeDisplay}</td>
                    <td class="px-4 py-3">${course.isMoedB ? '<span class="bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded-full dark:bg-red-900 dark:text-red-300">×‘×³</span>' : '<span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full dark:bg-blue-900 dark:text-blue-300">××³</span>'}</td>
                    <td class="px-4 py-3 text-center">
                        <button class="edit-btn p-1 text-blue-500 hover:text-blue-700" data-id="${course.id}"><i data-lucide="edit" class="w-4 h-4"></i></button>
                        <button class="delete-btn p-1 text-red-500 hover:text-red-700" data-id="${course.id}"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>
                `;
                courseListEl.appendChild(row);
            });
            lucide.createIcons();
        }

        function calculateAndRenderSummary() {
            const coursesWithGrades = state.courses.filter(c => !c.isPassFail);
            const numCourses = state.courses.length;

            if (numCourses === 0) {
                avgGradeEl.textContent = '0.00';
                totalCreditsEl.textContent = '0';
                highestGradeEl.textContent = '-';
                lowestGradeEl.textContent = '-';
                degreeProgressBar.style.width = '0%';
                degreeProgressText.textContent = '0%';
                return;
            }

            let totalCredits = state.courses.reduce((sum, c) => sum + parseFloat(c.credits), 0);
            let weightedGradeSum = 0;
            let highest = { grade: -1, name: '' };
            let lowest = { grade: 101, name: '' };
            
            let creditsForAvg = 0;

            coursesWithGrades.forEach(c => {
                const credits = parseFloat(c.credits);
                const grade = parseInt(c.grade);
                weightedGradeSum += grade * credits;
                creditsForAvg += credits;
                if (grade > highest.grade) highest = { grade, name: c.name };
                if (grade < lowest.grade) lowest = { grade, name: c.name };
            });

            const avgGrade = creditsForAvg > 0 ? (weightedGradeSum / creditsForAvg) : 0;
            avgGradeEl.textContent = avgGrade.toFixed(2);
            totalCreditsEl.textContent = totalCredits;
            highestGradeEl.textContent = coursesWithGrades.length > 0 ? `${highest.name} (${highest.grade})` : '-';
            lowestGradeEl.textContent = coursesWithGrades.length > 0 ? `${lowest.name} (${lowest.grade})` : '-';
            
            const requiredCredits = parseFloat(state.userInfo.requiredCredits) || 1;
            const progress = Math.min(100, (totalCredits / requiredCredits) * 100);
            degreeProgressBar.style.width = `${progress}%`;
            degreeProgressText.textContent = `${progress.toFixed(1)}%`;
            
            if (progress >= 100) {
                launchConfetti();
            }
        }

        function renderAggregatedAverages(element, groupBy) {
            element.innerHTML = '';
            const groups = {};
            const coursesWithGrades = state.courses.filter(c => !c.isPassFail);

            coursesWithGrades.forEach(c => {
                const key = c[groupBy];
                if (!groups[key]) {
                    groups[key] = { weightedSum: 0, credits: 0 };
                }
                groups[key].weightedSum += c.grade * c.credits;
                groups[key].credits += c.credits;
            });

            const keys = Object.keys(groups).sort((a,b) => (groupBy === 'semester' ? a-b : a.localeCompare(b, 'he')));
            if (keys.length === 0) {
                element.innerHTML = `<p class="text-gray-400">××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”.</p>`;
                return;
            }
            
            keys.forEach(key => {
                const avg = (groups[key].weightedSum / groups[key].credits).toFixed(2);
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-gray-100 dark:bg-gray-700 p-2 rounded-md';
                const prefix = groupBy === 'semester' ? '×¡××¡×˜×¨ ' : '';
                div.innerHTML = `
                    <span class="font-semibold text-gray-700 dark:text-gray-300">${prefix}${key}</span>
                    <span class="font-bold text-blue-600 dark:text-blue-400">${avg}</span>
                `;
                element.appendChild(div);
            });
        }

        const renderSemesterAverages = () => renderAggregatedAverages(semesterAveragesEl, 'semester');
        const renderCategoryAverages = () => renderAggregatedAverages(categoryAveragesEl, 'category');


        function renderCharts() {
            renderMoedChart();
            renderTrendChart();
        }

        function renderMoedChart() {
            if (moedChart) moedChart.destroy();
            let moedA = state.courses.filter(c => !c.isMoedB).length;
            let moedB = state.courses.filter(c => c.isMoedB).length;

            moedChart = new Chart(document.getElementById('moed-chart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['××•×¢×“ ×\'', '××•×¢×“ ×‘\''],
                    datasets: [{
                        data: [moedA, moedB],
                        backgroundColor: ['#3b82f6', '#ef4444'],
                        borderWidth: 0,
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: state.darkMode ? '#e5e7eb' : '#4b5563', font: chartDefaultFont } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const value = context.raw;
                                    const percentage = total > 0 ? (value / total * 100).toFixed(1) : 0;
                                    return `${context.label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderTrendChart() {
            if (trendChart) trendChart.destroy();
            const semesters = {};
            const coursesWithGrades = state.courses.filter(c => !c.isPassFail);
            coursesWithGrades.forEach(c => {
                if (!semesters[c.semester]) semesters[c.semester] = { weightedSum: 0, credits: 0 };
                semesters[c.semester].weightedSum += c.grade * c.credits;
                semesters[c.semester].credits += c.credits;
            });
            const labels = Object.keys(semesters).sort((a,b) => a-b);
            const data = labels.map(key => (semesters[key].weightedSum / semesters[key].credits));

            trendChart = new Chart(document.getElementById('trend-chart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels.map(l => `×¡××¡×˜×¨ ${l}`),
                    datasets: [{
                        label: '×××•×¦×¢ ×¡××¡×˜×¨×™××œ×™',
                        data: data,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.3,
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: false, ticks: { color: state.darkMode ? '#9ca3af' : '#6b7280' } },
                        x: { ticks: { color: state.darkMode ? '#9ca3af' : '#6b7280' } }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
        
        function updateHeader() {
            headerSubtitle.textContent = state.userInfo.name ? `×‘×¨×•×š ×”×‘×, ${state.userInfo.name}!` : `×‘×¨×•×š ×”×‘×!`;
            headerTitle.textContent = state.userInfo.major ? `××¢×§×‘ ××§×“××™: ${state.userInfo.major}` : `×œ×•×— ×‘×§×¨×” ××§×“××™`;
        }

        // --- EVENT HANDLERS ---
        
        isPassFailInput.addEventListener('change', (e) => {
            if (e.target.checked) {
                gradeInput.disabled = true;
                gradeInput.value = '';
                gradeInput.classList.add('bg-gray-200', 'dark:bg-gray-600');
            } else {
                gradeInput.disabled = false;
                 gradeInput.classList.remove('bg-gray-200', 'dark:bg-gray-600');
            }
        });

        courseForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = courseNameInput.value.trim();
            const credits = parseFloat(creditsInput.value);
            const isPassFail = isPassFailInput.checked;
            const grade = isPassFail ? null : parseInt(gradeInput.value);
            const semester = parseInt(semesterInput.value);
            const isMoedB = isMoedBInput.checked;
            const category = courseCategoryInput.value;

            if (!name || isNaN(credits) || credits < 0 || isNaN(semester) || semester < 1 || (!isPassFail && (isNaN(grade) || grade < 0 || grade > 100))) {
                alert('× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª ×‘×¢×¨×›×™× ×—×•×§×™×™×.');
                return;
            }

            const courseData = { name, credits, grade, semester, isMoedB, category, isPassFail };

            if (state.editMode.active) {
                const index = state.courses.findIndex(c => c.id === state.editMode.courseId);
                if (index > -1) {
                    state.courses[index] = { ...state.courses[index], ...courseData };
                }
                exitEditMode();
            } else {
                state.courses.push({ id: Date.now(), ...courseData });
            }
            
            courseForm.reset();
            gradeInput.disabled = false;
            gradeInput.classList.remove('bg-gray-200', 'dark:bg-gray-600');
            updateDashboard();
        });

        courseListEl.addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (!target) return;
            
            const id = parseInt(target.dataset.id);

            if (target.classList.contains('delete-btn')) {
                state.courses = state.courses.filter(c => c.id !== id);
                if (state.editMode.active && state.editMode.courseId === id) {
                    exitEditMode();
                }
                updateDashboard();
            } else if (target.classList.contains('edit-btn')) {
                enterEditMode(id);
            }
        });

        function enterEditMode(id) {
            const course = state.courses.find(c => c.id === id);
            if (!course) return;
            state.editMode = { active: true, courseId: id };
            
            courseNameInput.value = course.name;
            creditsInput.value = course.credits;
            isPassFailInput.checked = course.isPassFail;
            gradeInput.value = course.isPassFail ? '' : course.grade;
            gradeInput.disabled = course.isPassFail;
            if (course.isPassFail) gradeInput.classList.add('bg-gray-200', 'dark:bg-gray-600');
            else gradeInput.classList.remove('bg-gray-200', 'dark:bg-gray-600');
            semesterInput.value = course.semester;
            isMoedBInput.checked = course.isMoedB;
            courseCategoryInput.value = course.category;
            
            formTitle.textContent = '×¢×¨×™×›×ª ×§×•×¨×¡';
            submitBtn.textContent = '×©××•×¨ ×©×™× ×•×™×™×';
            cancelEditBtn.classList.remove('hidden');
            document.getElementById('form-container').scrollIntoView({ behavior: 'smooth' });
        }

        function exitEditMode() {
            state.editMode = { active: false, courseId: null };
            formTitle.textContent = '×”×•×¡×¤×ª ×§×•×¨×¡ ×—×“×©';
            submitBtn.textContent = '×”×•×¡×£ ×§×•×¨×¡';
            cancelEditBtn.classList.add('hidden');
            courseForm.reset();
            gradeInput.disabled = false;
            gradeInput.classList.remove('bg-gray-200', 'dark:bg-gray-600');
        }

        cancelEditBtn.addEventListener('click', exitEditMode);
        
        // --- Modal Handlers (Settings, Confirm, What-If) ---
        document.getElementById('settings-btn').addEventListener('click', () => settingsModal.classList.remove('hidden'));
        document.getElementById('close-settings-btn').addEventListener('click', () => settingsModal.classList.add('hidden'));
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) settingsModal.classList.add('hidden');
        });

        settingsForm.addEventListener('submit', (e) => {
            e.preventDefault();
            state.userInfo = {
                name: userNameInput.value.trim(),
                institution: institutionInput.value.trim(),
                major: majorInput.value.trim(),
                requiredCredits: parseFloat(requiredCreditsInput.value) || 120,
                categories: userCategoriesInput.value.split(',').map(c => c.trim()).filter(Boolean)
            };
            settingsModal.classList.add('hidden');
            populateCategoryDropdowns();
            updateDashboard();
        });
        
        document.getElementById('clear-data-btn').addEventListener('click', () => confirmModal.classList.remove('hidden'));
        document.getElementById('cancel-delete-btn').addEventListener('click', () => confirmModal.classList.add('hidden'));
        confirmModal.addEventListener('click', (e) => {
            if (e.target === confirmModal) confirmModal.classList.add('hidden');
        });
        document.getElementById('confirm-delete-btn').addEventListener('click', () => {
            state.courses = [];
            state.userInfo = { name: '', institution: '', major: '', requiredCredits: 120, categories: ['×—×•×‘×”', '×‘×—×™×¨×”', '×›×œ×œ×™', '×¡×¤×•×¨×˜'] };
            confirmModal.classList.add('hidden');
            settingsModal.classList.add('hidden');
            exitEditMode();
            init(); // Re-initialize to reset everything
        });

        // What-If Modal
        document.getElementById('what-if-btn').addEventListener('click', () => {
            whatIfModal.classList.remove('hidden');
            resetAndCalculateWhatIf();
        });
        document.getElementById('close-what-if-btn').addEventListener('click', () => whatIfModal.classList.add('hidden'));
        whatIfModal.addEventListener('click', e => {
            if (e.target === whatIfModal) whatIfModal.classList.add('hidden');
        });
        document.getElementById('add-what-if-course-btn').addEventListener('click', () => {
            addWhatIfCourseRow();
        });
        whatIfCoursesContainer.addEventListener('input', () => calculateWhatIf());

        // Info Modal
        document.getElementById('info-btn').addEventListener('click', () => infoModal.classList.remove('hidden'));
        document.getElementById('close-info-btn').addEventListener('click', () => infoModal.classList.add('hidden'));
        infoModal.addEventListener('click', e => {
            if (e.target === infoModal) infoModal.classList.add('hidden');
        });

        // Dark Mode
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        darkModeToggle.addEventListener('click', () => {
            state.darkMode = !state.darkMode;
            applyDarkMode();
            updateDashboard();
        });

        function applyDarkMode() {
            document.documentElement.classList.toggle('dark', state.darkMode);
        }

        // Export to CSV
        document.getElementById('export-csv-btn').addEventListener('click', () => {
            if (state.courses.length === 0) {
                alert('××™×Ÿ × ×ª×•× ×™× ×œ×™×™×¦×•×.');
                return;
            }
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            csvContent += "×©× ×”×§×•×¨×¡,×§×˜×’×•×¨×™×”,× ×§×•×“×•×ª ×–×›×•×ª,×¦×™×•×Ÿ,×¡××¡×˜×¨,××•×¢×“ ×‘,×‘×™× ××¨×™\r\n";
            
            const sortedCourses = getFilteredAndSortedCourses();

            sortedCourses.forEach(course => {
                const row = [course.name, course.category, course.credits, course.isPassFail ? "×‘×™× ××¨×™" : course.grade, course.semester, course.isMoedB ? '×›×Ÿ' : '×œ×', course.isPassFail ? '×›×Ÿ' : '×œ×'].join(',');
                csvContent += row + "\r\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "academic_grades.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // --- Filtering and Sorting ---
        function getFilteredAndSortedCourses() {
            let courses = [...state.courses];

            // Filter
            if (state.viewState.searchTerm) {
                courses = courses.filter(c => c.name.toLowerCase().includes(state.viewState.searchTerm.toLowerCase()));
            }
            if (state.viewState.filterSemester !== 'all') {
                courses = courses.filter(c => c.semester == state.viewState.filterSemester);
            }
            if (state.viewState.filterCategory !== 'all') {
                courses = courses.filter(c => c.category === state.viewState.filterCategory);
            }

            // Sort
            courses.sort((a, b) => {
                const aVal = a[state.viewState.sortBy];
                const bVal = b[state.viewState.sortBy];
                
                let comparison = 0;
                if (typeof aVal === 'string') {
                    comparison = aVal.localeCompare(bVal, 'he');
                } else {
                    comparison = aVal - bVal;
                }

                return state.viewState.sortOrder === 'asc' ? comparison : -comparison;
            });

            return courses;
        }

        searchInput.addEventListener('input', (e) => {
            state.viewState.searchTerm = e.target.value;
            renderTable();
        });
        filterSemesterEl.addEventListener('change', (e) => {
            state.viewState.filterSemester = e.target.value;
            renderTable();
        });
        filterCategoryEl.addEventListener('change', (e) => {
            state.viewState.filterCategory = e.target.value;
            renderTable();
        });
        document.querySelectorAll('.sortable').forEach(header => {
            header.addEventListener('click', () => {
                const sortBy = header.dataset.sort;
                if (state.viewState.sortBy === sortBy) {
                    state.viewState.sortOrder = state.viewState.sortOrder === 'asc' ? 'desc' : 'asc';
                } else {
                    state.viewState.sortBy = sortBy;
                    state.viewState.sortOrder = 'asc';
                }
                renderTable();
            });
        });

        function populateFilterOptions() {
            const semesters = [...new Set(state.courses.map(c => c.semester))].sort((a,b) => a-b);
            filterSemesterEl.innerHTML = '<option value="all">×›×œ ×”×¡××¡×˜×¨×™×</option>';
            semesters.forEach(s => {
                const option = new Option(`×¡××¡×˜×¨ ${s}`, s);
                filterSemesterEl.add(option);
            });
            filterSemesterEl.value = state.viewState.filterSemester;

            filterCategoryEl.innerHTML = '<option value="all">×›×œ ×”×§×˜×’×•×¨×™×•×ª</option>';
            state.userInfo.categories.forEach(c => {
                 const option = new Option(c, c);
                 filterCategoryEl.add(option);
            });
            filterCategoryEl.value = state.viewState.filterCategory;
        }


        // --- What-If Calculator Logic ---
        function addWhatIfCourseRow() {
            const row = document.createElement('div');
            row.className = 'grid grid-cols-2 gap-2 what-if-row';
            row.innerHTML = `
                <input type="number" placeholder="×¦×™×•×Ÿ (0-100)" class="what-if-grade w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-gray-200 dark:placeholder-gray-500">
                <input type="number" step="0.5" placeholder="× &quot;×–" class="what-if-credits w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-gray-200 dark:placeholder-gray-500">
            `;
            whatIfCoursesContainer.appendChild(row);
        }

        function calculateWhatIf() {
            const coursesWithGrades = state.courses.filter(c => !c.isPassFail);
            let currentWeightedSum = coursesWithGrades.reduce((sum, c) => sum + (c.grade * c.credits), 0);
            let currentCreditsForAvg = coursesWithGrades.reduce((sum, c) => sum + c.credits, 0);

            let whatIfWeightedSum = 0;
            let whatIfCredits = 0;

            document.querySelectorAll('.what-if-row').forEach(row => {
                const grade = parseFloat(row.querySelector('.what-if-grade').value);
                const credits = parseFloat(row.querySelector('.what-if-credits').value);
                if (!isNaN(grade) && !isNaN(credits) && grade >= 0 && grade <= 100 && credits > 0) {
                    whatIfWeightedSum += grade * credits;
                    whatIfCredits += credits;
                }
            });

            const totalWeightedSum = currentWeightedSum + whatIfWeightedSum;
            const totalCreditsForAvg = currentCreditsForAvg + whatIfCredits;

            const newAvg = totalCreditsForAvg > 0 ? (totalWeightedSum / totalCreditsForAvg) : 0;
            
            whatIfResultEl.textContent = newAvg.toFixed(2);
            whatIfCreditsInfoEl.textContent = `×¡×”"×› ${totalCreditsForAvg} × "×– ×‘×—×™×©×•×‘`;
        }
        
        function resetAndCalculateWhatIf() {
            whatIfCoursesContainer.innerHTML = '';
            addWhatIfCourseRow();
            calculateWhatIf();
        }

        // --- UTILS ---
        function launchConfetti() {
            confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } });
        }

        function populateCategoryDropdowns() {
            courseCategoryInput.innerHTML = '';
            state.userInfo.categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                courseCategoryInput.appendChild(option);
            });
        }

        // --- INITIALIZATION ---
        function init() {
            loadState();
            applyDarkMode();
            // Populate settings form with loaded data
            userNameInput.value = state.userInfo.name;
            institutionInput.value = state.userInfo.institution;
            majorInput.value = state.userInfo.major;
            requiredCreditsInput.value = state.userInfo.requiredCredits;
            userCategoriesInput.value = state.userInfo.categories.join(', ');
            
            populateCategoryDropdowns();
            updateDashboard();
            lucide.createIcons();
        }

        init();
    });
    </script>
</body>
</html>

